name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  check-secrets:
    name: Check AWS Configuration
    runs-on: ubuntu-latest
    outputs:
      has-aws-config: ${{ steps.check.outputs.has-config }}
    steps:
      - name: Check if AWS secrets are configured
        id: check
        run: |
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "has-config=true" >> $GITHUB_OUTPUT
            echo "✅ AWS credentials configured"
          else
            echo "has-config=false" >> $GITHUB_OUTPUT
            echo "⚠️ AWS credentials not configured - skipping deployment"
            echo "To enable deployments, configure the following secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - S3_BUCKET_NAME (for frontend)"
            echo "  - CLOUDFRONT_DISTRIBUTION_ID (for frontend)"
            echo "  - ECR_REGISTRY (for backend)"
          fi

  changes:
    name: Detect Changes
    needs: check-secrets
    if: needs.check-secrets.outputs.has-aws-config == 'true'
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

  deploy-frontend-web:
    name: Deploy Frontend (Web)
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build web
        run: npx expo export --platform web

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  deploy-backend:
    name: Deploy Backend
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -v

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and push Docker image
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          docker build -t estatefox-api .
          docker tag estatefox-api:latest \
            ${{ secrets.ECR_REGISTRY }}/estatefox-api:latest
          docker push ${{ secrets.ECR_REGISTRY }}/estatefox-api:latest

      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name estatefox-api \
            --image-uri ${{ secrets.ECR_REGISTRY }}/estatefox-api:latest
